---
title: "Make an Instrument"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Make an Instrument}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE}
library(tidyREDCap)
library(dplyr)
```

</br>


# The Problem 

REDCap exports data from projects with multiple instruments, where some participants may have completed different instruments. This can result in incomplete records where some instruments have missing data (represented by the value `NA` in R).

> **Example:** In a typical survey project, participants may complete different sets of questionnaires. Some may complete all sections (demographics, health, race/ethnicity), while others may only complete certain sections. This results in incomplete records for some instruments. 

In R, this data is displayed as
```{r}
sample_data <- readRDS(file = "./sample_survey_data.rds")

# To demonstrate the make_instrument function properly, 
# let's simulate incomplete records by setting some health instrument values to NA
sample_data <- sample_data
sample_data[c(2, 5), 
            c("height", "weight", "bmi", "comments", "mugshot", "health_complete")] <- NA

sample_data %>% 
  select(
    # Select record ID and health instrument columns
    record_id,
    # Select all columns for the health instrument
    height:health_complete
  ) %>% 
  # Make the table pretty
  knitr::kable()
```

It is often helpful to make a different data table that has the values for each questionnaire without the blank records. 

## Aside: Loading REDCap Data into R
See the [Import All Instruments from a REDCap Project](../doc/importInstruments.html) and [Importing from REDCap](../doc/useAPI.html) vignettes for details/information.

# The Solution

Pass the `make_instrument()` function to the name of a dataset and the names of the first and last variables in an instrument, and it will return a table that has the non-empty records for the instrument. For example, to extract the demographics instrument:

```{r}
make_instrument(sample_data, "name_first", "demographics_complete") %>% 
  knitr::kable()
```

To extract health information:

```{r}
make_instrument(sample_data, "height", "health_complete") %>% 
  knitr::kable()
```

Notice that records 2 and 5 are excluded from the health instrument table because they have completely missing health data. The `make_instrument()` function automatically removes records where all instrument variables are `NA` or empty, keeping only records with at least some data for that instrument.

To make an analysis dataset containing the race/ethnicity values **without** the subject ID:

```{r}
make_instrument(
  sample_data,
  "race___1", "race_and_ethnicity_complete",
  drop_which_when = TRUE
) %>% 
  knitr::kable()
```

